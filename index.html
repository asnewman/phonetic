<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phonetic</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="">
    <div id="ashjs"></div>

    <!-- <script src="./script.js" type="module"></script> -->
    <script>
      async function indexRoute(render, store) {
        return [
          header(),
          {
            div: [
              {
                input: [],
                type: "text",
                placeholder: "Search sentences...",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  const searchText = e.target.value;

                  if (!searchText) {
                    store.filteredData = null;
                  } else {
                    const filteredData = store.data.filter(
                      (sentence) =>
                        sentence.native
                          .toLowerCase()
                          .includes(searchText.toLowerCase()) ||
                        sentence.english
                          .toLowerCase()
                          .includes(searchText.toLowerCase()) ||
                        sentence.phonetic
                          .toLowerCase()
                          .includes(searchText.toLowerCase())
                    );
                    store.filteredData = filteredData;
                  }

                  render("sentences");
                },
              },
              {
                div: (store.filteredData || store.data).map((sentence) =>
                  sentenceCard(
                    sentence.native,
                    sentence.phonetic,
                    sentence.english
                  )
                ),
                id: "sentences",
              },
            ],
            class: "p-4",
          },
          {
            div: [
              {
                button: "Add Sentence",
                class: "flex-auto border h-10 rounded-lg mr-4",
                onclick: () => {
                  window.location.hash = "#add";
                },
              },
              {
                button: "Practice",
                class: "flex-auto bg-black text-white h-10 rounded-lg",
              },
            ],
            class: "fixed bottom-0 w-full bg-white p-4 border flex",
          },
        ];
      }

      async function addRoute(render, store) {
        return [
          header(),
          {
            div: [
              {
                input: [],
                type: "text",
                placeholder: "Native",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                },
              },
              {
                input: [],
                type: "text",
                placeholder: "Phonetic",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                },
              },
              {
                input: [],
                type: "text",
                placeholder: "English",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                },
              },
              {
                button: "Add",
                id: "add-button",
                class:
                  "w-full mt-2 bg-black text-white p-3 rounded-lg shadow cursor-pointer disabled:bg-gray-400",
                ...(isAddButtonDisabled() ? { disabled: "" } : {}),
                onclick: () => {
                  console.log("Adding sentence");
                  const native = document.querySelector(
                    'input[placeholder="Native"]'
                  ).value;
                  const phonetic = document.querySelector(
                    'input[placeholder="Phonetic"]'
                  ).value;
                  const english = document.querySelector(
                    'input[placeholder="English"]'
                  ).value;

                  store.data.push({
                    id: store.data.length + 1,
                    native,
                    phonetic,
                    english,
                  });

                  window.location.hash = "";
                },
              },
            ],
            class: "p-4",
          },
        ];
      }

      function isAddButtonDisabled() {
        const native = document.querySelector(
          'input[placeholder="Native"]'
        )?.value;
        const phonetic = document.querySelector(
          'input[placeholder="Phonetic"]'
        )?.value;
        const english = document.querySelector(
          'input[placeholder="English"]'
        )?.value;

        console.log({
          native,
          phonetic,
          english,
          result: !native || !phonetic || !english,
        });

        return !native || !phonetic || !english;
      }

      function header() {
        return {
          div: [{ h1: "Phonetic", class: "text-xl font-bold" }],
          class: "bg-black text-white p-4 cursor-pointer",
          onclick: () => {
            window.location.hash = "";
          },
        };
      }

      function sentenceCard(native, phonetic, english) {
        return {
          div: [
            {
              p: native,
              class: "text-lg font-bold",
            },
            {
              p: phonetic,
              class: "text-sm text-muted-foreground",
            },
            {
              p: english,
              class: "text-sm",
            },
          ],
          class:
            "mt-4 bg-card text-card-foreground p-3 rounded-lg shadow cursor-pointer",
        };
      }
      /**
       * ash.js helper functions
       */
      function extractPath(hash) {
        // Check if the string is not empty and starts with a hash
        if (hash && hash.startsWith("#")) {
          // Split the string at the question mark
          const parts = hash.split("?");

          // The first part of the array will contain everything before the '?'
          // Remove the '#' and return the result
          return parts[0].substring(1);
        }
        return ""; // Return an empty string if the conditions are not met
      }

      function getUrlInformation() {
        let hash = window.location.hash;
        const currentPath = extractPath(hash);
        let queryString = window.location.hash;
        let searchParams = new URLSearchParams(
          queryString.substring(1).replace(currentPath, "")
        );
        let paramsObject = {};

        for (let [key, value] of searchParams) {
          paramsObject[key] = value;
        }

        return { currentPath, paramsObject };
      }

      function findInTree(tree, id) {
        for (const element of tree) {
          if (element.id === id) {
            return element;
          }

          if (element.div && Array.isArray(element.div)) {
            const foundElement = findInTree(element.div, id);
            if (foundElement) {
              return foundElement;
            }
          }
        }

        return null;
      }

      /**
       * ash.js implementation
       */
      class Ash {
        routes = {};
        store = {};

        constructor(routes, store) {
          this.render = this.render.bind(this);

          this.routes = routes;
          this.store = store;

          this.render();

          window.onhashchange = () => {
            this.render();
          };
        }

        async render(id) {
          const { currentPath, paramsObject } = getUrlInformation();
          const tree = await this.routes[currentPath](this.render, this.store);

          if (id) {
            const newElement = findInTree(tree, id);
            if (newElement) {
              const node = this.createNode(newElement);
              if (node) {
                document.getElementById(id).replaceWith(node);
              }
            }

            return;
          }

          document.getElementById("ashjs").innerHTML = "";

          tree.forEach((element) => {
            const node = this.createNode(element);
            if (node) {
              document.getElementById("ashjs").appendChild(node);
            }
          });
        }

        createNode(element) {
          if (typeof element !== "object" || element === null) {
            return null;
          }

          // Get the tag name and its content or children
          const [tagName, contentOrChildren] = Object.entries(element)[0];

          // Create the DOM element for the tag
          const node = document.createElement(tagName);

          if (typeof contentOrChildren === "string") {
            node.textContent = contentOrChildren;
          } else if (Array.isArray(contentOrChildren)) {
            contentOrChildren.forEach((childElement) => {
              const childNode = this.createNode(childElement);
              if (childNode) {
                node.appendChild(childNode);
              }
            });
          }

          // Handle additional props (attributes or event listeners)
          for (const [key, value] of Object.entries(element)) {
            if (key !== tagName) {
              if (key.startsWith("on") && typeof value === "function") {
                node.addEventListener(key.substring(2).toLowerCase(), value);
              } else {
                node.setAttribute(key, value.toString());
              }
            }
          }

          return node;
        }
      }

      const routes = {
        "": indexRoute,
        add: addRoute,
      };

      const ash = new Ash(routes, {
        data: [
          {
            id: 1,
            native: "こんにちは",
            phonetic: "konnichiwa",
            english: "Hello",
          },
          {
            id: 2,
            native: "ありがとう",
            phonetic: "Arigatou",
            english: "Thank you",
          },
        ],
        filteredData: null,
      });
    </script>
  </body>
</html>
