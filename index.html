<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phonetic</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="">
    <div id="ashjs"></div>

    <!-- <script src="./script.js" type="module"></script> -->
    <script>
      async function indexRoute(render, store) {
        return [
          header(store),
          {
            div: [
              {
                input: [],
                type: "text",
                placeholder: "Search sentences...",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  const searchText = e.target.value;

                  if (!searchText) {
                    store.filteredData = null;
                  } else {
                    const filteredData = store.data.filter(
                      (sentence) =>
                        sentence.native
                          .toLowerCase()
                          .includes(searchText.toLowerCase()) ||
                        sentence.english
                          .toLowerCase()
                          .includes(searchText.toLowerCase()) ||
                        sentence.phonetic
                          .toLowerCase()
                          .includes(searchText.toLowerCase())
                    );
                    store.filteredData = filteredData;
                  }

                  render("sentences");
                },
              },
              {
                div: (store.filteredData || store.data).map((sentence) =>
                  sentenceCard(
                    sentence.native,
                    sentence.phonetic,
                    sentence.english
                  )
                ),
                id: "sentences",
              },
            ],
            class: "p-4",
          },
          {
            div: [
              {
                button: "Add Sentence",
                class: "flex-auto border h-10 rounded-lg mr-4",
                onclick: () => {
                  window.location.hash = "#add";
                },
              },
              {
                button: "Practice",
                class: "flex-auto bg-black text-white h-10 rounded-lg",
                onclick: () => {
                  window.location.hash = "#practice";
                },
              },
            ],
            class: "fixed bottom-0 w-full bg-white p-4 border flex",
          },
        ];
      }

      async function addRoute(render, store) {
        return [
          header(store),
          {
            div: [
            {
                input: [],
                type: "text",
                placeholder: "English",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                  render("auto-generate-button");
                },
              },
              {
                input: [],
                type: "text",
                placeholder: "Native",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                },
              },
              {
                input: [],
                type: "text",
                placeholder: "Phonetic",
                class:
                  "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => {
                  render("add-button");
                },
              },
              {
                button: "Auto-generate",
                id: "auto-generate-button",
                class: "w-full mt-2 bg-blue-500 text-white p-3 rounded-lg shadow cursor-pointer disabled:bg-gray-400 disabled:cursor-not-allowed",
                ...(isAutoGenerateButtonDisabled() || store.generating ? { disabled: "" } : {}),
                onclick: async () => {
                  const englishInput = document.querySelector('input[placeholder="English"]');
                  const nativeInput = document.querySelector('input[placeholder="Native"]');
                  const phoneticInput = document.querySelector('input[placeholder="Phonetic"]');

                  if (englishInput.value) {
                    try { 
                      store.generating = true
                      render("auto-generate-button");
                      const response = await fetch("https://asnewman-translate.web.val.run", {
                        method: "POST",
                        body: JSON.stringify({ english: englishInput.value }),
                      });

                      if (response.ok) {
                        const data = await response.json();
                        nativeInput.value = data.hebrew;
                        phoneticInput.value = data.phonetic;
                        render("add-button");
                      } else {
                        console.error("Error generating translation");
                      }
                    } catch (error) {
                      console.error("Error:", error);
                    } finally {
                      store.generating = false;
                      render("auto-generate-button");
                    }
                  }
                },
              },
              {
                button: "Add",
                id: "add-button",
                class:
                  "w-full mt-2 bg-black text-white p-3 rounded-lg shadow cursor-pointer disabled:bg-gray-400",
                ...(isAddButtonDisabled() ? { disabled: "" } : {}),
                onclick: () => {
                  console.log("Adding sentence");
                  const native = document.querySelector(
                    'input[placeholder="Native"]'
                  ).value;
                  const phonetic = document.querySelector(
                    'input[placeholder="Phonetic"]'
                  ).value;
                  const english = document.querySelector(
                    'input[placeholder="English"]'
                  ).value;

                  store.data.push({
                    id: store.data.length + 1,
                    native,
                    phonetic,
                    english,
                  });

                  window.location.hash = "";
                },
              },
            ],
            class: "p-4",
          },
        ];
      }

      async function practiceRoute(render, store) {
        if (store.randomSentence === null) {
          store.randomSentence = getRandomSentence(store);
        }
        return [
          header(store),
          {
            div: [
              {
                p: "Translate this sentence:",
                class: "text-lg font-bold mb-4",
              },
              {
                p: store.randomSentence.english,
                class: "text-xl mb-4",
              },
              {
                input: [],
                type: "text",
                placeholder: "Type the translation...",
                class: "w-full mt-2 px-3 py-2.5 text-sm rounded-sm border bg-[#ffffff] text-[#444444] focus:outline-[#aaaaaa] border-[#cccccc]",
                oninput: (e) => render("check-button"),
              },
              {
                button: "Check",
                id: "check-button",
                class: "w-full mt-4 bg-blue-500 text-white p-3 rounded-lg shadow cursor-pointer disabled:bg-gray-400",
                onclick: () => {
                  const userInput = document.querySelector('input[placeholder="Type the translation..."]').value.trim().toLowerCase();
                  const correctAnswer = store.randomSentence.phonetic.toLowerCase();
                  
                  if (userInput === correctAnswer) {
                    showToast(store, "Correct! Well done!", "success", render);
                  } else {
                    showToast(store, `Incorrect. The correct answer is: ${store.randomSentence.phonetic}`, "error", render);
                  }
                  
                  store.randomSentence = getRandomSentence(store);
                  render()
                },
              },
              {
                div: [
                  (store.toast.message ? {
                    p: store.toast.message,
                    class: store.toast.class
                  } : {div: ""})
                ],
                id: "toast-container",
                class: "fixed top-4 right-4 z-50",
              },
            ],
            class: "p-4",
          },
        ];
      }

      
      /**
       * Retrieves a random sentence from the store's data array.
       * Ensures that the new random sentence is different from the current one.
       * 
       * @param {Object} store - The store object containing the data array.
       * @returns {Object} A randomly selected sentence object.
       */
      function getRandomSentence(store) {
        const randomIndex = Math.floor(Math.random() * store.data.length);
        let newRandomSentence = store.data[randomIndex];

        if (store.randomSentence && newRandomSentence === store.randomSentence) {
          newRandomSentence = getRandomSentence(store)
        }

        return newRandomSentence
      }

      function isAutoGenerateButtonDisabled() {
        const english = document.querySelector(
          'input[placeholder="English"]'
        )?.value;
        return !english;
      }

      function isAddButtonDisabled() {
        const native = document.querySelector(
          'input[placeholder="Native"]'
        )?.value;
        const phonetic = document.querySelector(
          'input[placeholder="Phonetic"]'
        )?.value;
        const english = document.querySelector(
          'input[placeholder="English"]'
        )?.value;

        console.log({
          native,
          phonetic,
          english,
          result: !native || !phonetic || !english,
        });

        return !native || !phonetic || !english;
      }

      function header(store) {
        return {
          div: [{ h1: "Phonetic", class: "text-xl font-bold" }],
          class: "bg-black text-white p-4 cursor-pointer",
          onclick: () => {
            window.location.hash = "";
            store.randomSentence = null
          },
        };
      }

      function sentenceCard(native, phonetic, english) {
        return {
          div: [
            {
              p: native,
              class: "text-lg font-bold",
            },
            {
              p: phonetic,
              class: "text-sm text-muted-foreground",
            },
            {
              p: english,
              class: "text-sm",
            },
          ],
          class:
            "mt-4 bg-card text-card-foreground p-3 rounded-lg shadow cursor-pointer",
        };
      }

      /**
       * Displays a toast notification and automatically hides it after a set duration.
       * 
       * @param {Object} store - The application's store object.
       * @param {string} message - The message to display in the toast.
       * @param {string} type - The type of toast, either "success" or "error".
       * @param {Function} render - The function to call to re-render the component.
       */
      function showToast(store, message, type, render) {
        store.toast.message = message;
        store.toast.class = `p-4 rounded-lg shadow-lg ${type === "success" ? "bg-green-500" : "bg-red-500"} text-white mb-2`;
        
        setTimeout(() => {
          store.toast.class = "opacity-0 transition-opacity duration-300";
          render("toast-container")
          setTimeout(() => {
            store.toast.message = null;
            store.toast.class = null
            render("toast-container")
          }, 300);
        }, 5000);
      }

      /**
       * ash.js helper functions
       */
      function extractPath(hash) {
        // Check if the string is not empty and starts with a hash
        if (hash && hash.startsWith("#")) {
          // Split the string at the question mark
          const parts = hash.split("?");

          // The first part of the array will contain everything before the '?'
          // Remove the '#' and return the result
          return parts[0].substring(1);
        }
        return ""; // Return an empty string if the conditions are not met
      }

      function getUrlInformation() {
        let hash = window.location.hash;
        const currentPath = extractPath(hash);
        let queryString = window.location.hash;
        let searchParams = new URLSearchParams(
          queryString.substring(1).replace(currentPath, "")
        );
        let paramsObject = {};

        for (let [key, value] of searchParams) {
          paramsObject[key] = value;
        }

        return { currentPath, paramsObject };
      }

      function findInTree(tree, id) {
        for (const element of tree) {
          if (element.id === id) {
            return element;
          }

          if (element.div && Array.isArray(element.div)) {
            const foundElement = findInTree(element.div, id);
            if (foundElement) {
              return foundElement;
            }
          }
        }

        return null;
      }

      /**
       * ash.js implementation
       */
      class Ash {
        routes = {};
        store = {};

        constructor(routes, store) {
          this.render = this.render.bind(this);

          this.routes = routes;
          this.store = store;

          this.render();

          window.onhashchange = () => {
            this.render();
          };
        }

        async render(id) {
          const { currentPath, paramsObject } = getUrlInformation();
          const tree = await this.routes[currentPath](this.render, this.store);

          console.trace("rendering", id)

          if (id) {
            const newElement = findInTree(tree, id);
            if (newElement) {
              const node = this.createNode(newElement);
              if (node) {
                document.getElementById(id).replaceWith(node);
              }
            }

            return;
          }

          document.getElementById("ashjs").innerHTML = "";

          tree.forEach((element) => {
            const node = this.createNode(element);
            if (node) {
              document.getElementById("ashjs").appendChild(node);
            }
          });
        }

        createNode(element) {
          if (typeof element !== "object" || element === null) {
            return null;
          }

          // Get the tag name and its content or children
          const [tagName, contentOrChildren] = Object.entries(element)[0];

          // Create the DOM element for the tag
          const node = document.createElement(tagName);

          if (typeof contentOrChildren === "string") {
            node.textContent = contentOrChildren;
          } else if (Array.isArray(contentOrChildren)) {
            contentOrChildren.forEach((childElement) => {
              const childNode = this.createNode(childElement);
              if (childNode) {
                node.appendChild(childNode);
              }
            });
          }

          // Handle additional props (attributes or event listeners)
          for (const [key, value] of Object.entries(element)) {
            if (key !== tagName) {
              if (key.startsWith("on") && typeof value === "function") {
                node.addEventListener(key.substring(2).toLowerCase(), value);
              } else {
                node.setAttribute(key, value.toString());
              }
            }
          }

          return node;
        }
      }

      const routes = {
        "": indexRoute,
        add: addRoute,
        practice: practiceRoute,
      };

      const ash = new Ash(routes, {
        data: [
          {
            id: 1,
            native: "こんにちは",
            phonetic: "konnichiwa",
            english: "Hello",
          },
          {
            id: 2,
            native: "ありがとう",
            phonetic: "Arigatou",
            english: "Thank you",
          },
        ],
        filteredData: null,
        generating: false,
        randomSentence: null,
        toast: {
          message: null,
          class: null,
        }
      });
    </script>
  </body>
</html>
